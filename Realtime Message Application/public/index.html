<!DOCTYPE html>
<head>
  <title>Realtime Messages with Pusher</title>
  <style>
    body {
      background-color: #55789e;
    }

    h1 {
      color: #e0e1dd;
      font-size: 24px;
    }

    div.messages {
      background-color: whitesmoke;
      padding: 10px;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #e0e1dd;
      font-size: 16px;
    }

    button {
      background-color: #415a77;
      color: #e0e1dd;
      padding: 10px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Realtime Messages with Pusher</h1>
  <div class="">
    <form id="mesSender">
      <input type="text" id="userName" placeholder="Your Name" required />
      <br />
      <textarea id="newMessage" rows="4" placeholder="Enter Message"></textarea>
      <br />
      <button type="submit">Send Message</button>
    </form>
  </div>

  <div id="messages"></div>
  <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
  <script>
    (function () {
      // Enable pusher logging - don't include this in production
      Pusher.logToConsole = true;

      var pusher = new Pusher("08b1d4ea43d9060f06bb", {
        cluster: "mt1",
        encrypted: true,
      });

      var channel = pusher.subscribe("my-channel");
      var messages = document.getElementById("messages");
      channel.bind("my-event", newComments);
      document
        .querySelector("#mesSender")
        .addEventListener("submit", addComment);

      function newComments(data) {
        console.log(data);
        var el = document.createElement("div");
        el.innerHTML = `${data.message} <small>${data.name}</small>`;
        messages.appendChild(el);
      }

      function addComment(event) {
        event.preventDefault();
        var newComment = {
          name: document.getElementById("userName").value,
          message: document.getElementById("newMessage").value,
        };
        console.log(newComment);

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/comment", true);
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhr.onreadystatechange = function () {
          if (xhr.readyState != 4 || xhr.status != 200) return;
          console.log(xhr.responseText);
        };

        xhr.send(JSON.stringify(newComment));
      }
    })();
  </script>
</body>
